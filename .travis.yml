language: cpp
sudo: false
matrix:
  include:
    - os: linux
      env: PYTHON=3.3 CPP=11 GCC=4.8
      addons:
        apt:
          sources: [ubuntu-toolchain-r-test, kubuntu-backports, deadsnakes]
          packages: [g++-4.8, cmake, python3.3, lcov]
    - os: linux
      env: PYTHON=3.4 CPP=11 GCC=4.8
      addons:
        apt:
          sources: [ubuntu-toolchain-r-test, kubuntu-backports, deadsnakes]
          packages: [g++-4.8, cmake, python3.4, lcov]
    - os: linux
      env: PYTHON=3.5 CPP=11 GCC=4.8
      addons:
        apt:
          sources: [ubuntu-toolchain-r-test, kubuntu-backports, deadsnakes]
          packages: [g++-4.8, cmake, python3.5, lcov]
    - os: linux
      env: PYTHON=3.5 CPP=11 GCC=4.8
      addons:
        apt:
          sources: [ubuntu-toolchain-r-test, kubuntu-backports, deadsnakes]
          packages: [g++-4.8, cmake, python3.6, lcov]
before_install:
  - export CPP=-std=c++$CPP
  - export CFLAGS=-coverage
  - export CXX=g++-$GCC CC=gcc-$GCC
  - pip install --user --upgrade pip virtualenv
  - virtualenv -p python$PYTHON venv
  - source venv/bin/activate
  - pip install -r requirements.txt
  - pip install -r test_requirements.txt
cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/Library/Caches/pip
install:
  python setup.py develop
script:
  pytest --cov=batoid --cov-report=xml
after_success:
  - "ls -rtlha build/*/src/*.gc*"
  - cp build/*/src/*.gc* src/
#  - cp build/*/pysrc/*.gc* pysrc/
  - gcov-4.8 -o src/ src/*.cpp
# - gcov-4.8 -o src/ src/*.cpp -o pysrc/ pysrc/*.cpp
  - bash <(curl -s https://codecov.io/bash)
